#!/usr/bin/env python3
"""
Test suite for Afghan cover art generator functionality.

Run with:
    pytest -v tests/test_generator.py
"""

import os
import sys
import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from afcover.generator import (
    generate_cover,
    AfghanCoverGenerator,
)
from afcover.bot import (
    parse_request,
    extract_relevant_phrases,
)
from afcover.library import (
    ReferenceLibrary,
)


class TestGenerator:
    """Test suite for Afghan cover art generator."""

    def setup_method(self):
        """Set up test environment before each test."""
        # Create a test output directory
        self.test_output_dir = Path(__file__).parent / "test_output"
        self.test_output_dir.mkdir(exist_ok=True)
        
        # Define a mock reference image path
        self.mock_reference = Path(__file__).parent / "fixtures" / "mock_reference.jpg"
        if not self.mock_reference.exists():
            # Create a parent directory if it doesn't exist
            self.mock_reference.parent.mkdir(exist_ok=True, parents=True)
            
            # Create a simple 1x1 pixel image file for testing if it doesn't exist
            try:
                with open(self.mock_reference, "wb") as f:
                    # Simple 1x1 pixel JPEG
                    f.write(bytes.fromhex("FFD8FFE000104A4649460001010100600060000FFDB004300080606070605080707070909080A0C140D0C0B0B0C1912130F141D1A1F1E1D1A1C1C20242E2720222C231C1C2837292C30313434341F27393D38323C2E333432FFDB0043010909090C0B0C180D0D1832211C213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232FFC00011080001000103012200021101031101FFC4001F0000010501010101010100000000000000000102030405060708090A0BFFC400B5100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F0100030101010101010101010000000000000102030405060708090A0BFFC400B51100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFDA000C03010002110311003F00FD51E2BE73FD84BF6B0FDA4BE357C4EF899A2FC66B7F0CA687E10BF921D3F50B0D3FC3F6F7DA95B44912E236D42D8DC46E5A36753B0A654EE27393F46D7F447D5939A3CF2BEBE87E61ED1F3F2F2AF99FF66CBBBC9AFBE225BEA10AF9B6BABC6909322B8D88233815F4C499E6BE5EF85BE17BCF0A7C53F1FD8EA282397FB522B9018670D240320F4E3D2BCCE22F0EABC708AB4695D29AF7ADE693D16AF4D535D59D984CC634E6F997C4BBBF2FF0033CB7C6FF00B63EA9F09BC2D7BE3CF8B1FB07FC79F0A7856C022DC6A9ADFC1AD474F8159DB0A03B694CCCCCDD15549278009AE9FC13FB497C2FF001DF853FB774DF857F16A3B584AABEA71F80F558EC5493B41FB4B40161C9E3E6C64F4CD749FB43FFC144BE1D7ECE3A9E91A1F893E02FED6BA8EA9771D9DBEA7A4FC11D624D2AD1E5C8125C4F35988D23E09655CB38C88D5CF15F2A78ABE3EDFF00FC1422FBC09F0AE5FDA9BE2C7C36F097C22D5EDBC61E27F11F81FC1B6DA7D9B49A7CAB222C42E2668E391B72A92FBD9402E13E52C3F33CA788957AD4A9DE9734652AD9471F0C4454E9DD28C1FB6E5B27A2778F2DF4764CFB1AD9628469B7517349C572B83B73EBCAD5AE96F67ADEE7D87FF0F03F809FF00440FE337FE1B8D7FFF0091E8FF0087A1FC04FF00A207F199FF00D9B9AF3F2C45FF00F23D79CF8D3F63AF8A3F19BE2CF85F5DF0CFECFDF1A3E117C3BD0EC3EC5A8784FC51AE5D788A0F1425C8C5C4A6D649561119C6228F701F7B771B47B3F846FC4DF891E065D7BC557963AE780E1BBB9B582E3C1FE1E934D96EA6864689A4170F35C46D186C30D87246323A1AFADCDF33AB84CC68559D3950C3C1B7513508C9A71B28FB48B5295B7D1C5595EDDCF268E1E9CF0F3505CF37657777F8DAD674936B6D537A792B58D0F81DF1FBC37FB407C38B1F1AF85AF9AFEC2F4BABC1348F05DD8DD44DB258675FBB246E391E8410411907C17E38CB178ABF686BE5B8F8D5FF0A3AC6DF4E8E4B0B3D7BC3F06B06ED8CA47DACE65B698C5129C15F9B2EDB7819AFAEB41F05693E0FF000FD9687A369D67A5E95A7C296F67A7D8DBA416D6B120C246914602A228E1554000701457CFDFF000523FDA6BE0DFC2DF843E32F839E3AF19596977BAE69972BA0C56F6975793EB90BC6D12BC11DBAC8CDBF769C2B29538C835F079466F8DA39D61AB626A2AB4A9B6DC229592BEB38DE32D5A5649BB5BAB3D7D1C761E9BC2CE11F75BD357FDEDE56D1DBF95B4F5EDF51783FC5DA4F8FBC2BA6F88741BF8752D235784DC59DE4472B32139FC0F4207507915A95F31FF00C12D7F680F13FC65FD9D6E2DBC557EFA96BFE0BF10EA5E15FB7CCB896FADA0942DBCCFF00DEC416123B1FB2C727AD7D375FB3E5D88AD8AC34314A8CA8A9C537192BC64D2BF2B76BAD6F6D1DD6A7C4D78C6157D9B7CCADA3D9FAEFD349790574F8F515F3D78AFF006AAF88DE1FB9BE89BC18B730D95C3DB4AFA7DFC734FBD1B691B0F214077819C303B46580DC011C5780E6DBFE0A4D04B74893F8E3E0B2AF95E59DD0FC2C92F25C7CCB9C6A79C13C7B57F323C54862333C361F0F87954A352A462B9A56E5949452BA5ABB3E9B7AB3EE7098494D4E5D63BC57F9AFC8FD0FF008A7F13FC3FF09BC0BAB78C7C5DAB41A1F87F4784DCE9BA95D6760880B1C2FDEE8AA4900124015C6FFC35F7C3FFF00A2A9E04FFB2BBA77FF235F9E7FB467C19D7BE3AFFC13BBE35D84C627D4B56F0BEAA21BA8ADD61485A4B591CA0450A100CE3A93C935F223FC3BF1AFC11FF00822FF822D3C4516EB7D66FF00558A59FC2B7BA80B66FB55CBCD2C37168FBE392E235658DE40DB0A6F01410C3F10C1F88197D1C4422A8CD38CAA4B9D4D72B838CE30DDC5E92515F13DADCCAD75FAFD1C8E6DF237CBB347AB4EDA5FD74F5B1F76FC53FF00829F7ECD7F0F7C45A86897FE39B7D52E34F998DC4DA17873598E1BA1D510CF15BB472105B2CD1B3AA7F78035D67ECFFF00F0501F84BFB52F8BAEB46F08F88A6FED8B3B6FB7DC69B7F632E9F7F359E519AE121B9559645427255376ECCB31C063F9B7FB22FC5BF037EC7FFB3B6A5F14B5CF157C40B793C71AED9689E15F00E97A80D37C4178B2C722B2DD5D5ACBE54F68882591F7CB1E70BB1991D8FD23E09BE8FC0BFB4AEB1A9DAFC42F127C466D5BC3F0DB493F88E3B392E2D25499CEE84369F6A4A9C1C3AB1DC0F190715F599CE639461F1B5E74A84AA4E9CB965C9351D5CB9ED2526EFCCAD76EEAF6E87915309987B28295452B2BFC2DFBBA6AB9525F27A1F13FC58F8D7F1214F8A3C27F063FB76F34D8751BD82EE0D27C63A0E9F2E9BAB5A4B22CAB14D0CD84702320B30661B704038AE63E10FFC140FF686D2FE3C7C3BF0CF823F6A2F09F887C41AF6B76760ED79E0DF0F8B5B64958213333E9DCB00CD9E09C0E3902BEBCFDABBE1DFC21F82FE15F1478F3E207C38D03C553EB1AB47A8E9F17883C3BA74D7165147216F2EDA4BBB78CB47B4A964E55B73A8CA935F9EFF1DBE067C3BF037EDE7F02D7E1CE8769E05D1BC63AF699A84BE13D36D52D6CA48A399645963B35558DCAAA362851BC3E401B8D7E6B92E1F1558DA2B0D45C6ACB19074E8CAAB9AB464A31926F91B72B2B6BE9A5D1F530F1C1D1C3BA9525C90F6338D46A2A4AD29452B25CF156EEFAEAD9F717C60F89BA66A36CFA0F88BE2FFC02D0349D56DA7B7D5B4D93E26E9B73ACECC88C92595CC526FB49C3B0538601B86042B01F18FED09FB41F853C25FB5CF86750F117ED01F0A3C7DE1F5F0A5D5AEADA4699F17E0B2F10462E2E11E234F1CE04F6C4F950C8A5CBB332A9C06183F44FED95FB6D7ECE1FB32F8A9B4D97E2B7C22F10EA9E19D3CDF3E9DE2BB6D09658A3964F2BCB0D716BB9CA8DF92140E7A1AF883F66BF81FF00B2B7ED41FB64EA1E3FD3BC5FF000A6E13C27A347A7E9F15D7882D352BB85E4C98E36B458BCFCA2C0EE24607963D2BE4F29CE9E0F16F15CB4F134253F7215A354E85DF23725CEE2F9927EF5DEBDDBD8F5AA6551C4615D1BC69D4E5FDF538B4ABF2A56F76CDDE37F861A1F3CFC2DF887F0C21F8B1E288749FDBABC1DE1EB283558D2CE05F1C787E431287725B24FB0B70E3196E82BE83FD8F3E2F7C40F1CF8B3E29DADEFF6F6A3E13D26FA113D9EA5F15AD75BB60E23CA34715D2C8B10CB9C18C8C7A0AF47FDB73C03FB19FECA1F08EEB58F127C45F85B797DE228E4B2D174DB3F14D9DF6B73DC48BB4195608D9E084312D994852C028DC40AFC67F14F8FBE247EDBDF11B51F08FC15F8EBE2CFC36F0FDBCB25AEB9AE78434A5B7D22C2DE16DFE45BCDE74F7570DB8061B76230E1A5240C7DAE5F5315987B5C553AB2A3F57A72E5BD4B29BE6E58CA1CBA4ED1576EE973CF9D3A146D4D3F7FDA4AD6B3B2D2FEF2E7D1F45F7BE47F5C99C9EF5F947E20FF0082CC7EC9FA3D80B9B7B8F176B6E632761F08EACB1E78F97775E7D40AE17F636FF82B37C52F8B1F1C7C31F0F7E257C27D3F4E8BC49A82D94368DE16D4B5ABB46982B6D6BDB390A04CFDC62C9B8E41032335F4FE2270DD7CAB0B4F134EB42B47994959CACECEE9DE2D5F54F4FBBD0E0CA71EB155A54E51719596D74F5E8D3D8FD40F8D5F1ABC33F02BE1EEA7E2EF166A10E93A2E9B1EFBA9A56FF67215574124B2390A91C68ACF231D8A8A58D7E76F87FF00E0B27FB3F5FEAA71E21D7345B1795963BBD5FC1FAB47691EEC8DD3492D9A08D7078DC4F3D39AF4DFF82C878F3C79E16F8337BE1F4D2B5BD3BC23E36B5BBD2BC4097B612DAC734B023BFD911D94A4934B26D88ED23636E6A78AF82BF683C65F067E0F7C44F057C46F0FF00C12F19F85FC1A97369A20F0DF8CEFB44B3BBB8B55459ADEDD21D52599A4B8DF2105CB30DA413C57E5D90F01D6CC71D87C1AA90E7AAEAD3936D250E5937BB56B3F2D59F5D99E618AC3E1AA56E594BD9F344B497BC97E8AE7D61FB7CFEDC9F00BF6557F17F84FE20789EF535BF1B7858C71E9969A15F6A1788E2CE1BB54334516518098F2C32016FA577FFD933F6B6F867FB5C7C0DD2BC6BF0DEF1A7B1957CA9E1952E2DEBE6F96E99596D5A290637A30C11823823BE7F133E3E7C26F883FB44FEC77F1227B4F017873E1AEBB0781BC5A914375ADB40F65205BEB6646B8885A800C05C91E6E1401FC206AFF00041FC6EF881FF0514F02785BC7DA95A789AFBC1DE16BFD43C5D636D6B2C7A7E9A12051690DC4525AC5244D3B4A12494E1DA22A9C2E6BEDF3FF0002E86032AC3E3E9CDCE53E78D484A36946D16D4A328BD25795AD66AD7773E7B2BF11EAE3F114B0F28A515CD16A57525757524D3F75B564EFAEA7E807FC141BF698F04FECCDF00F5BF11EBBA840BAADA41229D1A2955B56BD936111429B89201206FC64228279C0AF3FF00F824C7C3FF00197807F63B7B5F166A5AA5C5C6B9ACDE6B56FA6EA570D35CDA5A4DB1231BE414CDD2470AB1C004286C0C57C45FB6EFC3CDDBF5AFC50F1B7C53B4F8B3E3BBAD4AF12E2C7C5FE07D5FC35ADE9B672CEB1C4C96CF10B7BB0A86320B3B2C9B883B769ADBFF0082B9FC39D6F58FDB2FE1DE9FE31D5B57B4F875E1FF0FDCC7AE5E6A1736E74FB6F1048F1ECB67D3644595A4F95A47F30301C0CEEC93F06B863C3AAB83CAE8D4A31ABF5AF677ABBF3B75A6A0A4DC21F674529599F40B3CAFCB8EC44253869525CB05B28B6A5FE2EF7DBD4FAE2F7FE0ABF6B736AC20F07689E1B9E442A63FF00849256BA4C8C1F9E3B48940F5C09067A1C66B0FF006D8F8CFF00D91FB387C64F89D6DA9D8EA3AFE95E15BCF0BD9DEE9BA34DA9DD5F5F488FB5A112C3B2DE3773C30764540C4126BF26F53F10F88345B88752F0E78AB5FD02FA1F35ADF50D3352BAB4B984BF57471224888DDD492057DDBFF0004E7F8EDE3CF147FC13DFC6DAA78E22D7FC75A9F876E35B4B7F13DF2CB7DAC6B1637F1DB87B6866984939DE63C8077B30DC5B7104FDC673E1651A59253C1D1AD4E52A957D9FBADB94AC9DA70BA6ED6EAB43E3A9F176A58FE6AD52135CF1739DF496965AAE68F9EC7CAFF00B59F8FB47F881E28D0BC3BE15F12F89B5CF0D7C38D32DB41D2F58F185DC971AD6A448F32EA4B9666647775F325DA8DB5412BB7687AFD2EF8A1F15756FD883F61ED134F9BE1E7827C23F0E7C3DE20B0B1D46F7C47AEDCDC41A4BB5E43733C9F65B389DDE20EEF1EE6DAA8AC8A77950B5F9C1FB28EB1FB6AFC2DF849E38F0978AF495D7AC35BF10DD6A76DE2A934AB7D4E78EDDCAA79BA70B88278D61DA8CA55863CC24B1CE49F7AF8E7F1B3C6FF001D3FE09C5F0B357F0DF89347D4BE20E97F142F2CB4EB1F13D9C325DADBC90DD4D0342A6D66696F110DA00016C97DC7AE07C2F1053C0E54F11EDA9D08C65AC9B718CD732938B51BB4E2FA2BAB3D4F9DC76271789AB4E587A92938B4B4B49A5AADAF6E6BE9E677DFB157EDCBE34F81BACEB3A7FC52F1AD95BFC25F1A5C0D36CF56B0D192EF4FB0D4220BE5C3752A0D96A0C632629D1C05CE194822BCEBFE0ABFF16F57F897FB42695F0A6DBE24F863E10F83FC271A6B9AC789BC4968F7B0BDCDF2B7D8ECEDE28F97DC13CD95CA952CAB1A3065702BACF13F8BBF642F0CF886EF47D4BF681D475FD4B4F999269F41F086BD7DA7DCB28FBAF034A91490F5F953767D3A57CA5F137C71FB29CBF19F55BBF0DFC64F89375E13FB4116B0DD78334F86E7C98C61496824BAB794B704BCBE52F3D0638F6720C9A86231988E6AB4D4ECA374A6AA5A9CA504E4AEACB6B27AEBA9F498BA75947D9AB5958F5AFF00827F7FC143F5EF0D7ED4767F08FE2078AF5CBEF0C7C4C7FECC4D4F59B9927B9D0B5A0A5AD5C487E724CDF2038C7CD20CE370FDEF53FF0082857C66D534FF827FF0C350F85BE35D0FC6DE1BBB97585B9B9D22E8DC4B61335EC824FB44318778A48D8A64B72A63393C1F8E7F6B8F87FF00B427C2BBDF07F8ABE05FC57D16FE7F14E9D01D47C39E2BF0DD8E877BA9CB187416F3DB0B8FB4408488D5A12CCC36B29071C63F661FDBF3E057ECD1F017E267C3AD634FB5F10F88BC6363796B697B269AF1C31E9F348244B9BC37AF0A444F92EBF248D9DEC08C815BE3726CC2AE12BE0A384A33AD4E54DEF18D93E672B7BD256693D12D6F6674CB170C4D0AF1A975096AEEE5A3D53BA4B4EB68BD75B9B7F093FE0ACDA6FC4CF197ED3B7D2FC3B7BAC0F81DA8DE47A6784B47D7248F5AD46D124B7F2C332C51431CD20891DF6AE5A574C3005481C1FEC71FB54FC51FD9C3E075F7C3DD5FC0FE28F883E38F15FC45D4757F1478E350D38FF6478696F9C1B482DA3551F69962544896D91902F95E6BB3616B82C7F692F05FC27F83BFB5C787BE25EB7F09FE3C7C75F08F896C6C5F48F87DE1CF0DDCDD7D9AD648A39ADE49219E3B69ADA38F32471F97285CC8E32C1B83F42785FF00698F0CDCF8E35AF02F8A348F127C38F1CE9315ADD5D7857C5D650D8DFB5A5C825651E5BCAB1DCE4ED478CB330CE00EA3DB8E6B9C7B19D693A3563569C9C94A10515CFCB24DA94B9B569A5A6D6BADB6F0AAE5D96CE8AA6A12E5E5B371725CAF5B27CAD26F5D9A49EBEA7CB7FF0005CDF877A7F877F686F873E3BB7B28EC751F13786E4D375EF296119BF8249222F9C65A47B59A29CE38649318C0ACF1FB337C0F83FE0963F0E1BC45F093E24F897C70BA6F8CE7B8F16EB7A5D9EAD1AFC39BE5B6B55B1B296E0310F7725C46C48DAA8D0AC991BB1957FE0B9DF1FF00C29F107E25FC2FF086897B26A3E1FF0168525FEA37D6C92C3A6CD35EBC5288E0963B9B6966FB3A404B3A491611E6DA7071B7C3BE367ED6DF0CBE20FFC127FE127C3AD27C5DA7EB1E3FB0935697FB1ADB67F685ADBA5DCA2DD66DB26D40A66F6B13C8C9E2BF27C964F2B7ECD53C4FB4963A9474A738C9252954DD38FC56777AE9A1F631CAB189D2E6E5972D2A928AC9A9A49C57B973D7AA7AF73EABFD953F683D4BF662FF82B97C39F11EB1A9B5F687E20F0BDC783AF2FDD77CBFD9F76A62B495CEEF9A45FB3DE44ACDC6FFBC7EF571FF00F0579D6BC33A2FC19F12F8A354D7BC3FA0F8DB427D1752F0F5C6A3793DB69FAA5B5DDFC16D0C9044A9249756F24D76F34515B466431DB3CD84DA5CB60F81FDB77F677F88DE32FF82CCFC1CD6BC33E05F17EB9A66B1A2683A7DA5DD8E8F753DB42F6D24B1CB1DCCA91306B72A1F11C9B5D8E70A0F22B27FE0A35FB7D7897E0F7C65D63E0DF86F40F0FC773E17B64B9F1378C752D22CF55934A599BC95B4B5B1BDB459659E68F2D33ACAA914793BD9F08DE7E1F249E7953FD964A6A5428AA93A91A778CDB84AEDA56BDFDD5EF6AF54B733CE73B860A12AD4EF34A3184A575CB17094B7776ADAAB5F547C41E2DF04E93FB407C19D1BC4DA7788F48F05FF0062CFF6878735092E56CB5AB795D4DC0FB44B3C62299248E18A55DB2311E5B0CF209F7CFF00827CFED61FB5C7ECFD716BA0F80F5DD3FC5BE05B2F1143A9789B57F13F85741B05B9B6FB3CD32322E9B73710C9705209963595D46E9CEFF00E2F5CF88D77E3A5F05FED8BA4FC3DF0E47E1D1E3D8F44F0CD8E9F67A4CDA6C5A5C9142EF69241771C12450A79EB242D2AC7BA358580663B4FA0FEC31FB46DE7EC87FF0510D37C396DE26D1757F06F8C3C34B35AC77D6F6B1C13EB1676EB1B0923B9B4B685A68E7B577442CFB6540E8489315FB46228E1F1586C1E2E9C26D4AAC77D13A8A2B96DD64F9A4DB576DDD75B5BE3E84EA53AF5E94E09FB2B3BADDA526DA7BDD5969A1F46FC3BFF00828A7C70F8E1FB44587C2CF875FB395D6A3E20F1169DAD5FC5AE78BBC4CFFDA1A4BD9F922D1A0B78C6EB698BB3EE2F23955C1462CE013F65C53C774D80CFA0AFF003B5F15F8E7F6A4B5FD87F55D7FE3378BAD63F015E5DC9A6DAFC30F0258D9F89ADE18A594A8F39B4DB0BB9A45B9B5791C4B3A844478C70446C7F677FE09F9FF051EF1F7C15F0F7C19F0D787BC4DE3DD6BC09E0FD2EC21D5E3D4B53B9BDB5B892DE15B7789E7F323884CDF219E30AB2B140A1CF0457D471270E63B09428CABC546AD69292E4E5946293BB7CF6949B4DFAB2B2D2C79D9371461B14E509AE5A4B6BDACA4F44AE96927A5DF53ED4F881F15FC29F0D34FB6BEF13EB30693677AE23B632292F349B776D8AA01662155C85CED0BF362BCAF5EFF00829B7ECE3A1F8CFE1CE8773F11AD9A7F889ABDAE9714312BDCBC0ED2846F3264546658A393CC6445DC81491B802DE33FF0005B4FDA67C3BA0FECB17DE05BEB78F56D5FC637B0A58E9C8EA92E9AB044F75E6DD2BE42AB3AC6A8B8E6476F4CD7E627ECBBE03F851F143F622F8ADAEFC6CF1C78C3C15E30B3D6B44D3F4CD6B45D5A4B1BBD16DE0926BFB37842CA7F75204B4672B2B88D76024ED1F9BF0DF03E1B19818E264E51A939CB5F763792514DBB5DB926D7DDB1ED63B3CA987C43A498ABC212E6D24BE2B26D2D754E29DDFAAEC7E8D7ED9DFF053BFD997E027C5AD6BC3FE0FF8A3A47C44BEB44DDABDAF87AD2EB5437522F28D0CB0A34718E0873300C0E42F19AD1FD957FE0A2DF0E3F6D1BEF125AE930EA7A3F887C253F953E8BA9046B88E3931E5CC8E849B8807F7A31CE4A32B1C5719FF04D0FF82517C2AF871F07FC33F123E316956DE33F1F78B74D4D42DEF2FFCB9ED34AB792306DE1825810AC531460D2B1667254E10E177FD374E38A385A386A77C4CE11A6D3F72F7BE89C925657D7B74DA9D4E62F2EC1D35F5794A9A5C928BD9B577152F89DDAD16FD3A9F19FF00C1347E1AEB7F003FE0AAA89E33F0958F87B59D3FC17ADCFA5DC5BA349147AE5BDD5A4B15D47233BB3C7B631B5589D8DB957A1C7D5FF00F0514F17F85FE2E7EDB1F05BE0EF87F5FD2FC49A94D757DAEDF69DA65DC7788966AF15BAF9A61660BB9EF646191F2B219D811B4BF923FB7D7C5EF16FED9BFF000511F0BBC31F0FEB3AB5BF85FC09A35AC734FA3C971043A95E5B431DDDE2B4A91F9A8AE2E2DA18B71C9596423E555C7DB5FF0004EBFF008220786FC29A859FC46F8E0B1F897C4513AB693E1E5F35747D19C1CBACF20F96EA70405C0065C92BBA3560A7EEB36CB6841E270390E0E9E1BDB2B4B9E3797BC97BC9C9CBECAB6B167C7E1B174E7471399622A4FD9BD1DBDC6D2D2DCB1F7BC9EBEA7DA5FB1FF00ECC3E14FD8DFE06D9F827C396EAD7520F32F758B94D973AADEE02BCF2F018725555470A854018AFA9A8A2BF31AB56A5795494E4E52937AE8DBDDE9E67E8B4E9C69C145249247CFF00FF0004B4FD9F3C31F0C7F63AF0E78D6CF48B5835BF1AE972C37579142BEEC8C225A7F983F6844C81C10CA4B05661C87F8E53FE0A77FB227C39F809F1A3E0BD8FC3AF065AF86743F16789D6DB50B6B2FF0044B7D4ADC5A5D9F2AE1D3E466C9555320765E319AFD18A2BE330595E2F0F99D7C652928FB4B38B5B46D2947FAF23D2C562E9548512934D41E8F7BF33934FE4ACB6DCFE80A8A28AFC73FAFC28A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A00FFFD9"))
            except Exception as e:
                pytest.skip(f"Could not create test image: {e}")

    def teardown_method(self):
        """Clean up after each test."""
        # Remove test output directory if it exists and is empty
        if self.test_output_dir.exists() and len(list(self.test_output_dir.iterdir())) == 0:
            self.test_output_dir.rmdir()

    @pytest.mark.parametrize("style,title,artist", [
        ("traditional", "Test Album", "Test Artist"),
        ("modern", "Modern Album", "New Artist"),
        ("fusion", "East West", "Global Artist"),
    ])
    def test_dry_run_variations(self, style, title, artist):
        """Test dry run with different style combinations."""
        # Skip if no reference image
        if not self.mock_reference.exists():
            pytest.skip("Mock reference image not available")

        # Mock API call to avoid actual API usage in tests
        with patch('afcover.generator.generate_cover', return_value={
            "dry_run": True,
            "estimated_cost": "$0.15",
            "num_images": 1,
            "resolution": "1K",
            "style": style,
            "message": f"Would generate 1 image(s) at 1K for $0.15"
        }):
            result = generate_cover(
                reference_images=[str(self.mock_reference)],
                title=title,
                artist=artist,
                style=style,
                dry_run=True,
            )
            
            assert result["dry_run"] is True
            assert result["style"] == style
            assert "estimated_cost" in result

    def test_generator_parameters_validation(self):
        """Test parameter validation in generator."""
        generator = AfghanCoverGenerator(output_dir=str(self.test_output_dir))
        
        # Test missing reference images
        with pytest.raises(ValueError, match="at least one reference image"):
            generator.generate(
                reference_images=[],
                title="Test Album",
                style="traditional",
            )
        
        # Test invalid style
        with pytest.raises(ValueError, match="Unknown style"):
            generator.generate(
                reference_images=[str(self.mock_reference)],
                title="Test Album",
                style="nonexistent_style",
            )
        
        # Test invalid regional style
        with pytest.raises(ValueError, match="Unknown regional style"):
            generator.generate(
                reference_images=[str(self.mock_reference)],
                title="Test Album",
                style="traditional",
                regional="nonexistent_region",
            )
        
        # Test invalid num_variations
        with pytest.raises(ValueError, match="num_variations must be between"):
            generator.generate(
                reference_images=[str(self.mock_reference)],
                title="Test Album",
                style="traditional",
                num_variations=10,
            )
    
    def test_natural_language_parsing(self):
        """Test the natural language parser for cover generation requests."""
        # Test title and artist extraction
        params = parse_request("Make a cover for 'Song Title' by Artist Name")
        assert params['title'] == "Song Title"
        assert params['artist'] == "Artist Name"
        
        # Test style extraction
        params = parse_request("Create a traditional Afghan cover with gold details")
        assert params['style'] == "traditional"
        assert params['custom'] == "with gold details"
        
        # Test regional style extraction
        params = parse_request("Generate modern Kabuli style cover for 'Watan'")
        assert params['style'] == "modern"
        assert params['regional'] == "kabuli"
        assert params['title'] == "Watan"
        
        # Test variations count extraction
        params = parse_request("I need 3 variations of a romantic cover for 'Dilbar'")
        assert params['style'] == "romantic"
        assert params['title'] == "Dilbar"
        assert params['num_variations'] == 3

    def test_extract_relevant_phrases(self):
        """Test extraction of relevant phrases from free text."""
        phrases = extract_relevant_phrases("I want a cover with mountains and traditional patterns in bright colors")
        assert "mountains" in phrases['elements']
        assert "traditional patterns" in phrases['elements']
        assert "bright colors" in phrases['colors']
        assert "traditional" in phrases['style_hints']

    @pytest.mark.parametrize("resolution,expected_cost", [
        ("1K", 0.15),
        ("2K", 0.15),
        ("4K", 0.30),
    ])
    def test_resolution_cost_calculation(self, resolution, expected_cost):
        """Test that resolution affects cost correctly."""
        result = estimate_cost(1, resolution)
        assert result == expected_cost

    def test_reference_library_functions(self):
        """Test reference library basic functions."""
        # Create a mock library with a temporary directory
        import tempfile
        temp_dir = tempfile.mkdtemp()
        library = ReferenceLibrary(base_dir=temp_dir)
        
        # Test directory creation
        assert Path(temp_dir, "artists").exists()
        assert Path(temp_dir, "styles").exists()
        
        # Test listing empty collections
        collections = library.list_collections()
        assert "artists" in collections
        assert "styles" in collections
        assert len(collections["artists"]) == 0
        assert len(collections["styles"]) == 0
        
        # Clean up
        import shutil
        shutil.rmtree(temp_dir)
    
    def test_extract_title_mood(self):
        """Test the title mood extraction functionality."""
        generator = AfghanCoverGenerator()
        
        # Test Dari/Pashto title mood extraction
        assert "love theme" in generator._extract_title_mood("عشق")
        assert "homeland theme" in generator._extract_title_mood("وطن")
        assert "homeland theme" in generator._extract_title_mood("watan")
        
        # Test non-mood title
        assert generator._extract_title_mood("Test Title") == ""

    def test_safe_filename(self):
        """Test safe filename generation."""
        generator = AfghanCoverGenerator()
        
        # Test basic conversion
        assert generator._safe_filename("Test Title") == "test-title"
        
        # Test special characters
        assert generator._safe_filename("Special!@#$%^&*()") == "special"
        
        # Test Dari/Pashto characters
        assert generator._safe_filename("دل تنها") == "untitled"  # Non-ASCII becomes untitled
        
        # Test empty string
        assert generator._safe_filename("") == "untitled"
        
        # Test long title truncation
        long_title = "This is a very long title that should be truncated because it exceeds thirty characters"
        assert len(generator._safe_filename(long_title)) <= 30


# Only run if executed directly (not imported)
if __name__ == "__main__":
    pytest.main(["-v", __file__])